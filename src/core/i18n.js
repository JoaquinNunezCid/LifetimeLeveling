const STORAGE_KEY = "levelup_lang";

const STRINGS = {
  es: {
    "app.title": "Lifetime Leveling",
    "nav.summary": "Resumen",
    "nav.goalsDaily": "Objetivos diarios",
    "nav.actions": "Objetivos extra",
    "nav.training": "Entrenamiento",
    "nav.stats": "Stats",
    "nav.achievements": "Logros",
    "nav.login": "Login",
    "nav.signup": "Crear cuenta",
    "nav.primary": "Navegacion principal",
    "nav.secondary": "Navegacion secundaria",
    "settings.menu": "Configuracion",
    "settings.goals": "Objetivos principales",
    "settings.logout": "Cerrar sesion",
    "auth.loginTitle": "Login",
    "auth.signupTitle": "Crear cuenta",
    "auth.name": "Nombre",
    "auth.email": "Email",
    "auth.password": "Password",
    "auth.passwordConfirm": "Repetir password",
    "auth.show": "Ver",
    "auth.hide": "Ocultar",
    "auth.loginButton": "Entrar",
    "auth.signupButton": "Crear",
    "auth.noAccount": "No tienes cuenta?",
    "auth.haveAccount": "Ya tienes cuenta?",
    "auth.helpPassword": "Password minimo 8 caracteres, al menos una letra y un numero.",
    "dashboard.user": "Usuario",
    "dashboard.today": "Hoy",
    "dashboard.level": "Nivel",
    "dashboard.xpCurrent": "XP actual",
    "dashboard.xpNeed": "XP para subir",
    "dashboard.xpLabel": "XP {current}/{total} (faltan {remaining})",
    "dashboard.editName": "Editar nombre",
    "dashboard.streak": "Racha",
    "dashboard.tokens": "Tokens",
    "dashboard.useToken": "Usar token",
    "dashboard.calendar": "Calendario",
    "dashboard.adminDate": "Admin fecha",
    "dashboard.levelUp": "Subir nivel",
    "dashboard.resetAccounts": "Reset cuentas",
    "dashboard.prevDay": "Dia -",
    "dashboard.nextDay": "Dia +",
    "dashboard.prevMonth": "Mes -",
    "dashboard.nextMonth": "Mes +",
    "dashboard.todayBtn": "Hoy",
    "dashboard.goalsDay": "Objetivos del dia",
    "dashboard.done": "Completados",
    "dashboard.pending": "Pendientes",
    "dashboard.achievements": "Logros ganados",
    "label.level": "Nivel",
    "label.xp": "XP",
    "actions.title": "Objetivos extra",
    "training.title": "Entrenamiento",
    "training.subtitle": "Ejercicios y repeticiones",
    "training.days": "Dias de la semana",
    "training.add": "Agregar ejercicio",
    "training.exercise": "Ejercicio",
    "training.reps": "Repeticiones",
    "training.actions": "Acciones",
    "training.done": "Logradas",
    "goalsMain.title": "Objetivos principales",
    "goals.save": "Guardar objetivos",
    "goals.title": "Objetivos diarios",
    "goal.exercise": "Hacer ejercicio (min)",
    "goal.steps": "Cantidad de pasos",
    "goal.study": "Estudiar (min)",
    "goal.read": "Leer (min)",
    "goal.calories": "Calorias del dia",
    "goal.water": "Litros de agua",
    "stats.title": "Stats del usuario",
    "achievements.title": "Logros ganados",
    "modal.inputPlaceholder": "Escribi...",
    "modal.editNameTitle": "Cambiar nombre",
    "modal.namePlaceholder": "Tu nombre",
    "settings.title": "Configuracion",
    "settings.visibleName": "Nombre visible",
    "settings.avatar": "Imagen de usuario",
    "settings.cancel": "Cancelar",
    "settings.save": "Guardar",
    "settings.password": "Password",
    "settings.passwordConfirm": "Repetir password",
    "settings.language": "Idioma",
    "monthPicker.title": "Seleccionar mes",
    "monthPicker.year": "Ano",
    "monthPicker.month": "Mes",
    "monthPicker.cancel": "Cancelar",
    "monthPicker.apply": "Ver",
    "dayModal.title": "Dia",
    "dayModal.done": "Objetivos hechos",
    "dayModal.missing": "Objetivos faltantes",
    "dayModal.close": "Cerrar",
    "defeat.title": "Has sido derrotado",
    "defeat.text": "Tu vida llego a cero. Podes revivir para seguir.",
    "defeat.continue": "Cerrar",
    "defeat.revive": "Revivir",
    "defeat.reviveHint": "Tu vida llego a cero. Podes revivir para seguir.",
    "toast.settingsSaved": "Configuracion guardada",
    "dead.blocked": "Estas derrotado. Revivi para continuar.",
    "toast.imageFail": "No se pudo procesar la imagen.",
    "toast.passwordWeak": "Password debil: {issues}.",
    "password.mismatch": "Las passwords no coinciden.",
    "password.minLength": "minimo 8 caracteres",
    "password.letter": "al menos una letra",
    "password.number": "al menos un numero",
    "auth.invalidEmail": "Ingresa un email valido.",
    "auth.passwordRequired": "Ingresa tu password.",
    "auth.invalidCredentials": "Credenciales invalidas.",
    "auth.loginFailed": "No se pudo iniciar sesion",
    "auth.emailTaken": "El email ya esta registrado.",
    "auth.emailInUse": "Email en uso",
    "auth.signupFailed": "No se pudo crear la cuenta",
    "auth.signupFields": "Completa los campos.",
    "auth.signupLoginFailed": "Cuenta creada, pero no se pudo iniciar sesion.",
    "auth.loginNow": "Inicia sesion",
    "goals.saved": "Objetivos guardados",
    "goals.alreadyDone": "Ya completaste este objetivo hoy",
    "goals.notSet": "Define un valor para este objetivo",
    "goals.completed": "Objetivo completado: +{xp} XP",
    "actions.locked": "Completa el objetivo principal de esta categoria.",
    "actions.lockedWith": "Primero completa el objetivo principal: {label}.",
    "actions.alreadyDone": "Ya hiciste esta accion hoy",
    "actions.logged": "Accion registrada: {label} (+{xp} XP)",
    "actions.loggedGeneric": "Accion registrada (+{xp} XP)",
    "level.up": "Subiste a nivel {level}",
    "skip.noTokens": "No tienes tokens disponibles.",
    "skip.alreadyComplete": "Ya completaste el objetivo de hoy.",
    "skip.alreadyUsed": "Ya usaste un token hoy.",
    "skip.confirm": "Usar 1 token para saltear hoy y mantener la racha?",
    "skip.done": "Dia salteado con token.",
    "skip.usedLabel": "Token usado hoy",
    "skip.completeLabel": "Objetivo cumplido",
    "skip.useLabel": "Usar token",
    "admin.notFound": "No se encontro el admin.",
    "admin.resetDone": "Cuentas reseteadas.",
    "admin.resetConfirm": "Resetear todas las cuentas? Se mantiene solo el admin.",
    "day.skipText": "Dia salteado con token. La racha se mantiene.",
    "day.missionSuccess": "Mision cumplida, se completaron con exito todas las misiones diarias.",
    "day.missionFail": "Mision fallida, faltaron misiones diarias por completar.",
    "day.death": "Ese dia fue el dia de la muerte.",
    "day.noneDone": "No completaste objetivos.",
    "day.noneMissing": "Sin objetivos pendientes.",
    "achievements.empty": "Aun no tienes logros. Sigue sumando XP.",
    "achievements.none": "Sin logros",
    "achievements.noneDetail": "Todavia no sumaste logros en esta categoria.",
    "achievements.max": "Logro maximo",
    "achievements.completed": "Completado",
    "achievement.level": "Niveles",
    "achievement.streak": "Rachas",
    "achievement.goals": "Objetivos diarios",
    "achievement.actions": "Objetivos extra",
    "achievement.toast": "Logro conseguido: {title}",
    "achievement.toastXp": "Logro conseguido: {title} (+{xp} XP)",
    "stats.strength": "Fuerza",
    "stats.dexterity": "Destreza",
    "stats.constitution": "Constitucion",
    "stats.intelligence": "Inteligencia",
    "stats.wisdom": "Sabiduria",
    "stats.strengthHint": "Ejercicio y entrenamiento",
    "stats.dexterityHint": "Ejercicio y pasos",
    "stats.constitutionHint": "Pasos y agua",
    "stats.intelligenceHint": "Estudio",
    "stats.wisdomHint": "Lectura",
    "stats.level": "Nivel {level}",
    "stats.points": "{points} pts",
    "stats.progress": "Progreso {current} / {target}",
    "training.none": "Sin ejercicios para {day}.",
    "training.edit": "Editar",
    "training.remove": "Quitar",
    "training.new": "Nuevo ejercicio",
    "training.repsTitle": "Repeticiones",
    "training.editTitle": "Editar ejercicio",
    "training.editReps": "Editar repeticiones",
    "training.namePlaceholder": "Ej: Flexiones",
    "training.repsPlaceholder": "Ej: 3x12",
    "goals.add": "Agregar",
    "lang.es": "ES",
    "lang.en": "EN",
    "day.monday": "Lunes",
    "day.tuesday": "Martes",
    "day.wednesday": "Miercoles",
    "day.thursday": "Jueves",
    "day.friday": "Viernes",
    "day.saturday": "Sabado",
    "day.sunday": "Domingo",
  },
  en: {
    "app.title": "Lifetime Leveling",
    "nav.summary": "Summary",
    "nav.goalsDaily": "Daily goals",
    "nav.actions": "Extra actions",
    "nav.training": "Training",
    "nav.stats": "Stats",
    "nav.achievements": "Achievements",
    "nav.login": "Login",
    "nav.signup": "Sign up",
    "nav.primary": "Primary navigation",
    "nav.secondary": "Secondary navigation",
    "settings.menu": "Settings",
    "settings.goals": "Main goals",
    "settings.logout": "Log out",
    "auth.loginTitle": "Login",
    "auth.signupTitle": "Sign up",
    "auth.name": "Name",
    "auth.email": "Email",
    "auth.password": "Password",
    "auth.passwordConfirm": "Confirm password",
    "auth.show": "Show",
    "auth.hide": "Hide",
    "auth.loginButton": "Enter",
    "auth.signupButton": "Create",
    "auth.noAccount": "No account?",
    "auth.haveAccount": "Already have an account?",
    "auth.helpPassword": "Password min 8 chars, at least one letter and one number.",
    "dashboard.user": "User",
    "dashboard.today": "Today",
    "dashboard.level": "Level",
    "dashboard.xpCurrent": "Current XP",
    "dashboard.xpNeed": "XP to level",
    "dashboard.xpLabel": "XP {current}/{total} ({remaining} to go)",
    "dashboard.editName": "Edit name",
    "dashboard.streak": "Streak",
    "dashboard.tokens": "Tokens",
    "dashboard.useToken": "Use token",
    "dashboard.calendar": "Calendar",
    "dashboard.adminDate": "Admin date",
    "dashboard.levelUp": "Level up",
    "dashboard.resetAccounts": "Reset accounts",
    "dashboard.prevDay": "Day -",
    "dashboard.nextDay": "Day +",
    "dashboard.prevMonth": "Month -",
    "dashboard.nextMonth": "Month +",
    "dashboard.todayBtn": "Today",
    "dashboard.goalsDay": "Goals of the day",
    "dashboard.done": "Completed",
    "dashboard.pending": "Pending",
    "dashboard.achievements": "Achievements",
    "label.level": "Level",
    "label.xp": "XP",
    "actions.title": "Extra actions",
    "training.title": "Training",
    "training.subtitle": "Exercises and reps",
    "training.days": "Days of the week",
    "training.add": "Add exercise",
    "training.exercise": "Exercise",
    "training.reps": "Reps",
    "training.actions": "Actions",
    "training.done": "Completed",
    "goalsMain.title": "Main goals",
    "goals.save": "Save goals",
    "goals.title": "Daily goals",
    "goal.exercise": "Exercise (min)",
    "goal.steps": "Steps",
    "goal.study": "Study (min)",
    "goal.read": "Read (min)",
    "goal.calories": "Calories",
    "goal.water": "Water (liters)",
    "stats.title": "User stats",
    "achievements.title": "Achievements",
    "modal.inputPlaceholder": "Type...",
    "modal.editNameTitle": "Change name",
    "modal.namePlaceholder": "Your name",
    "settings.title": "Settings",
    "settings.visibleName": "Display name",
    "settings.avatar": "User image",
    "settings.cancel": "Cancel",
    "settings.save": "Save",
    "settings.password": "Password",
    "settings.passwordConfirm": "Confirm password",
    "settings.language": "Language",
    "monthPicker.title": "Select month",
    "monthPicker.year": "Year",
    "monthPicker.month": "Month",
    "monthPicker.cancel": "Cancel",
    "monthPicker.apply": "View",
    "dayModal.title": "Day",
    "dayModal.done": "Goals done",
    "dayModal.missing": "Missing goals",
    "dayModal.close": "Close",
    "defeat.title": "You were defeated",
    "defeat.text": "Your life hit zero. Revive to keep going.",
    "defeat.continue": "Close",
    "defeat.revive": "Revive",
    "defeat.reviveHint": "Your life hit zero. Revive to keep going.",
    "toast.settingsSaved": "Settings saved",
    "dead.blocked": "You are defeated. Revive to continue.",
    "toast.imageFail": "Could not process the image.",
    "toast.passwordWeak": "Weak password: {issues}.",
    "password.mismatch": "Passwords do not match.",
    "password.minLength": "min 8 characters",
    "password.letter": "at least one letter",
    "password.number": "at least one number",
    "auth.invalidEmail": "Enter a valid email.",
    "auth.passwordRequired": "Enter your password.",
    "auth.invalidCredentials": "Invalid credentials.",
    "auth.loginFailed": "Login failed",
    "auth.emailTaken": "Email already registered.",
    "auth.emailInUse": "Email in use",
    "auth.signupFailed": "Could not create account",
    "auth.signupFields": "Fill in the fields.",
    "auth.signupLoginFailed": "Account created, but login failed.",
    "auth.loginNow": "Please log in",
    "goals.saved": "Goals saved",
    "goals.alreadyDone": "You already completed this goal today",
    "goals.notSet": "Set a value for this goal",
    "goals.completed": "Goal completed: +{xp} XP",
    "actions.locked": "Complete the main goal for this category.",
    "actions.lockedWith": "First complete the main goal: {label}.",
    "actions.alreadyDone": "You already did this action today",
    "actions.logged": "Action logged: {label} (+{xp} XP)",
    "actions.loggedGeneric": "Action logged (+{xp} XP)",
    "level.up": "You reached level {level}",
    "skip.noTokens": "No tokens available.",
    "skip.alreadyComplete": "You already completed today's goal.",
    "skip.alreadyUsed": "You already used a token today.",
    "skip.confirm": "Use 1 token to skip today and keep the streak?",
    "skip.done": "Day skipped with token.",
    "skip.usedLabel": "Token used today",
    "skip.completeLabel": "Goal completed",
    "skip.useLabel": "Use token",
    "admin.notFound": "Admin not found.",
    "admin.resetDone": "Accounts reset.",
    "admin.resetConfirm": "Reset all accounts? Only the admin stays.",
    "day.skipText": "Day skipped with token. Streak stays.",
    "day.missionSuccess": "Mission completed. Daily goals were achieved.",
    "day.missionFail": "Mission failed. Daily goals were missed.",
    "day.death": "That day was the day of your defeat.",
    "day.noneDone": "No goals completed.",
    "day.noneMissing": "No pending goals.",
    "achievements.empty": "No achievements yet. Keep earning XP.",
    "achievements.none": "No achievements",
    "achievements.noneDetail": "You still have no achievements in this category.",
    "achievements.max": "Top achievement",
    "achievements.completed": "Completed",
    "achievement.level": "Levels",
    "achievement.streak": "Streaks",
    "achievement.goals": "Daily goals",
    "achievement.actions": "Extra actions",
    "achievement.toast": "Achievement unlocked: {title}",
    "achievement.toastXp": "Achievement unlocked: {title} (+{xp} XP)",
    "stats.strength": "Strength",
    "stats.dexterity": "Dexterity",
    "stats.constitution": "Constitution",
    "stats.intelligence": "Intelligence",
    "stats.wisdom": "Wisdom",
    "stats.strengthHint": "Exercise and training",
    "stats.dexterityHint": "Exercise and steps",
    "stats.constitutionHint": "Steps and water",
    "stats.intelligenceHint": "Study",
    "stats.wisdomHint": "Reading",
    "stats.level": "Level {level}",
    "stats.points": "{points} pts",
    "stats.progress": "Progress {current} / {target}",
    "training.none": "No exercises for {day}.",
    "training.edit": "Edit",
    "training.remove": "Remove",
    "training.new": "New exercise",
    "training.repsTitle": "Reps",
    "training.editTitle": "Edit exercise",
    "training.editReps": "Edit reps",
    "training.namePlaceholder": "e.g. Push ups",
    "training.repsPlaceholder": "e.g. 3x12",
    "goals.add": "Add",
    "lang.es": "ES",
    "lang.en": "EN",
    "day.monday": "Monday",
    "day.tuesday": "Tuesday",
    "day.wednesday": "Wednesday",
    "day.thursday": "Thursday",
    "day.friday": "Friday",
    "day.saturday": "Saturday",
    "day.sunday": "Sunday",
  },
};

const CATEGORY_LABELS = {
  es: {
    Entrenamiento: "Entrenamiento",
    Movimiento: "Movimiento",
    Estudio: "Estudio",
    Lectura: "Lectura",
  },
  en: {
    Entrenamiento: "Training",
    Movimiento: "Movement",
    Estudio: "Study",
    Lectura: "Reading",
  },
};

const GOAL_LABELS = {
  es: {
    waterLiters: "Agua",
    calories: "Calorias",
    exerciseMinutes: "Ejercicio",
    readMinutes: "Leer",
    studyMinutes: "Estudiar",
    steps: "Pasos",
    waterLitersFull: "Agua (litros)",
    caloriesFull: "Calorias del dia",
    exerciseMinutesFull: "Ejercicio (min)",
    readMinutesFull: "Leer (min)",
    studyMinutesFull: "Estudiar (min)",
    stepsFull: "Pasos",
  },
  en: {
    waterLiters: "Water",
    calories: "Calories",
    exerciseMinutes: "Exercise",
    readMinutes: "Reading",
    studyMinutes: "Study",
    steps: "Steps",
    waterLitersFull: "Water (liters)",
    caloriesFull: "Calories",
    exerciseMinutesFull: "Exercise (min)",
    readMinutesFull: "Read (min)",
    studyMinutesFull: "Study (min)",
    stepsFull: "Steps",
  },
};

const DAY_LABELS = {
  es: {
    monday: "Lunes",
    tuesday: "Martes",
    wednesday: "Miercoles",
    thursday: "Jueves",
    friday: "Viernes",
    saturday: "Sabado",
    sunday: "Domingo",
  },
  en: {
    monday: "Monday",
    tuesday: "Tuesday",
    wednesday: "Wednesday",
    thursday: "Thursday",
    friday: "Friday",
    saturday: "Saturday",
    sunday: "Sunday",
  },
};

const ACTION_LABELS = {
  en: {
    entreno_facil: "Easy training",
    entreno_medio: "Medium training",
    entreno_dificil: "Hard training",
    caminar_30m: "Walk 30 min",
    caminar_1h: "Walk 1 hour",
    estudio_30m: "Study 30 min",
    estudio_1h: "Study 1 hour",
    estudio_2h: "Study 2 hours",
    leer_30m: "Read 30 min",
    leer_1h: "Read 1 hour",
    leer_2h: "Read 2 hours",
  },
};

const ACHIEVEMENT_TITLES = {
  en: {
    level_2: "First step: level 2",
    level_5: "Strong streak: level 5",
    level_10: "Double digits: level 10",
    level_25: "Mastery: level 25",
    level_50: "Legend: level 50",
    level_100: "Eternal: level 100",
    streak_3: "Early focus: streak 3",
    streak_7: "One full week",
    streak_14: "Two weeks straight",
    streak_30: "Perfect month",
    streak_60: "Two flawless months",
    streak_100: "One hundred days",
    goals_10: "10 goals completed",
    goals_50: "50 goals completed",
    goals_150: "150 goals completed",
    goals_300: "300 goals completed",
    goals_600: "600 goals completed",
    actions_20: "20 extra actions",
    actions_100: "100 extra actions",
    actions_300: "300 extra actions",
    actions_600: "600 extra actions",
    actions_1200: "1200 extra actions",
  },
};

export function getLanguage() {
  const stored = localStorage.getItem(STORAGE_KEY);
  if (stored === "en" || stored === "es") return stored;
  return "es";
}

export function t(key, params = {}) {
  const lang = getLanguage();
  const dict = STRINGS[lang] || STRINGS.es;
  const fallback = STRINGS.es[key] || key;
  let value = dict[key] || fallback;
  Object.keys(params).forEach((name) => {
    value = value.replaceAll(`{${name}}`, String(params[name]));
  });
  return value;
}

export function setLanguage(lang) {
  const next = lang === "en" ? "en" : "es";
  localStorage.setItem(STORAGE_KEY, next);
  document.documentElement.lang = next;
  applyTranslations();
  window.dispatchEvent(new CustomEvent("languagechange", { detail: { lang: next } }));
}

export function applyTranslations(root = document) {
  const applyText = (attr, setter) => {
    root.querySelectorAll(`[${attr}]`).forEach((el) => {
      const key = el.getAttribute(attr);
      if (!key) return;
      setter(el, t(key));
    });
  };
  applyText("data-i18n", (el, value) => { el.textContent = value; });
  applyText("data-i18n-placeholder", (el, value) => { el.setAttribute("placeholder", value); });
  applyText("data-i18n-aria-label", (el, value) => { el.setAttribute("aria-label", value); });
  applyText("data-i18n-title", (el, value) => { el.setAttribute("title", value); });
  document.title = t("app.title");
}

export function getCategoryLabel(category) {
  const lang = getLanguage();
  return CATEGORY_LABELS[lang]?.[category] || category;
}

export function getGoalLabel(key, { full = false } = {}) {
  const lang = getLanguage();
  const map = GOAL_LABELS[lang] || GOAL_LABELS.es;
  const suffix = full ? "Full" : "";
  return map[`${key}${suffix}`] || map[key] || key;
}

export function getDayLabel(dayKey) {
  const lang = getLanguage();
  return DAY_LABELS[lang]?.[dayKey] || dayKey;
}

export function getActionLabel(action) {
  const lang = getLanguage();
  const key = action?.key || "";
  return ACTION_LABELS[lang]?.[key] || action?.label || key;
}

export function getAchievementTitle(id, fallback) {
  const lang = getLanguage();
  return ACHIEVEMENT_TITLES[lang]?.[id] || fallback || id;
}
